<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Even geduld… je wordt ingelogd</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; display:grid; place-items:center; height:100vh; margin:0; background:#f6f7f9; color:#0f172a}
    .card{background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:24px 28px; box-shadow:0 8px 20px rgba(15,23,42,.06); max-width:520px}
    .muted{color:#6b7280; font-size:14px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Even geduld…</h1>
    <p class="muted">We ronden je login af en sturen je automatisch door.</p>
    <p id="status" class="muted"></p>
  </div>
  <script type="module">
    import { supabase } from "../js/supabaseClient.js";
    const url = new URL(window.location.href);
    const next = url.searchParams.get("next") || localStorage.getItem("mf-next") || "/";

    const status = document.getElementById('status');

    async function ensureSession(){
      try{
        // 1) Nieuwe flow (code in query): wissel code in voor sessie
        if (url.searchParams.get("code")) {
          const { data, error } = await supabase.auth.exchangeCodeForSession(window.location.href);
          if (error) throw error;
          window.location.replace(next);
          return;
        }

        // 2) Oude flow (tokens in hash #access_token=...): SDK pakt dit automatisch op na import.
        const { data: { session } } = await supabase.auth.getSession();
        if (session) { window.location.replace(next); return; }

        // 3) Luister op state changes (veilig vangnet)
        const { data: { subscription } } = supabase.auth.onAuthStateChange((_evt, sess) => {
          if (sess) window.location.replace(next);
        });

        // 4) Fallback: terug naar login na paar sec
        setTimeout(()=>{
          status.textContent = "We konden je niet automatisch aanmelden. Klik op terug naar login…";
          window.location.replace("/login/?next=" + encodeURIComponent(next));
        }, 5000);
      }catch(e){
        status.textContent = "Fout: " + e.message;
        setTimeout(()=> window.location.replace("/login/?next=" + encodeURIComponent(next)), 3000);
      }
    }

    ensureSession();
  </script>
</body>
</html>
