<script type="module">
  import { supabase, logout } from "./js/supabaseClient.js";

  // Lees ?next= uit de URL of uit storage
  const url = new URL(window.location.href);
  const next = url.searchParams.get("next") || localStorage.getItem("mf-next") || "/";

  // Zorg dat 'next' beschikbaar blijft tijdens OAuth/magic-link
  localStorage.setItem("mf-next", next);

  async function refresh() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      // direct door naar de gewenste pagina
      const dest = localStorage.getItem("mf-next") || "/";
      window.location.href = dest;
      return;
    }
    document.getElementById('loginArea').style.display = 'block';
    document.getElementById('userArea').style.display = 'none';
  }

  document.getElementById('googleBtn').addEventListener('click', async ()=>{
    // 'next' staat al in localStorage
    const redirectTo = `${window.location.origin}/login/auth/callback.html`;
    await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo } });
  });

  document.getElementById('emailBtn').addEventListener('click', async ()=>{
    const email = document.getElementById('email').value.trim();
    const msg = document.getElementById('emailMsg');
    msg.style.display = 'none';
    try{
      const redirectTo = `${window.location.origin}/login/auth/callback.html`;
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: redirectTo }
      });
      if (error) throw error;
      msg.textContent = "Magic link verzonden! Check je e-mail.";
      msg.className = "notice success";
      msg.style.display = "block";
    } catch(e){
      msg.textContent = "Er ging iets mis: " + e.message;
      msg.className = "notice error";
      msg.style.display = "block";
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', logout);

  refresh();
</script>
